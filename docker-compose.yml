version: '3.7'

services:
  local-proxy:
    image: nginx
    depends_on:
      - buyer
      - sso-profile
      - exred
      - soo
      - international
    ports:
      - '80:80'
    volumes:
      - './services/local-proxy/nginx_site.conf:/etc/nginx/conf.d/default.conf'

  db:
    image: postgres:9.5
    ports:
      - '5432:5432'
    # volumes:
    #   - db-data:/var/lib/postgresql/data

  redis:
    image: redis:3.2.11
    ports:
      - '6379:6379'
    volumes:
      - ./services/redis/redis.conf:/etc/redis.conf
      # - redis-data:/data
    command: redis-server /etc/redis.conf

  es:
    image: elasticsearch:5.6.8
    ports:
      - '9200:9200'
    environment:
      # Set memory
      ES_JAVA_OPTS: "-Xmx256m -Xms256m"
      # Disable security
      xpack.security.enabled: "false"
      xpack.monitoring.enabled: "false"
      xpack.graph.enabled: "false"
      xpack.watcher.enabled: "false"
      # Run in development mode to ignore bootstrap checks
      transport.host: "localhost"
    # volumes:
    #   - es-data:/usr/share/elasticsearch/data

  api:
    image: local-workspace/directory-api
    build:
      context: ../directory-api/
      dockerfile: services/directory-api/Dockerfile
    ports:
      - '8000:8000'
    env_file:
      - services/directory-api/.env
    depends_on:
      - db
      - redis
      - es

  buyer:
    image: local-workspace/directory-ui-buyer
    build:
      context: ../directory-ui-buyer/
      dockerfile: services/directory-ui-buyer/Dockerfile
    ports:
      - '8001:8001'
    env_file:
      - services/directory-ui-buyer/.env
    depends_on:
      - sso-proxy
      - redis

  exopps:
    image: local-workspace/export-opportunities
    build:
      context: ../export-opportunities/
      dockerfile: services/export-opportunities/Dockerfile
    ports:
      - '8002:8002'
    depends_on:
      - db
      - redis
      - es

  sso:
    image: local-workspace/directory-sso
    build:
      context: ../directory-sso/
      dockerfile: services/directory-sso/Dockerfile
    env_file:
      - services/directory-sso/.env
    ports:
      - '8003:8003'
    depends_on:
      - db
      - redis

  sso-proxy:
    image: local-workspace/directory-sso-proxy
    build:
      context: ../directory-sso-proxy/
      dockerfile: services/directory-sso-proxy/Dockerfile
    env_file:
      - services/directory-sso-proxy/.env
    ports:
      - '8004:8004'
    depends_on:
      - sso

  supplier:
    image: local-workspace/directory-ui-supplier
    build:
      context: ../directory-ui-supplier/
      dockerfile: services/directory-ui-supplier/Dockerfile
    env_file:
      - services/directory-ui-supplier/.env
    ports:
      - '8005:8005'
    depends_on:
      - sso-proxy

  sso-profile:
    image: local-workspace/directory-sso-profile
    build:
      context: ../directory-sso-profile/
      dockerfile: services/directory-sso-profile/Dockerfile
    env_file:
      - services/directory-sso-profile/.env
    ports:
      - '8006:8006'
    depends_on:
      - sso-proxy

  exred:
    image: local-workspace/great-domestic-ui
    build:
      context: ../great-domestic-ui/
      dockerfile: services/great-domestic-ui/Dockerfile
    env_file:
      - services/great-domestic-ui/.env
    ports:
      - '8007:8007'
    depends_on:
      - db
      - redis
      - api
      - sso-proxy
      - cms
      - forms-api

  soo:
    image: local-workspace/navigator
    build:
      context: ../navigator/
      dockerfile: services/navigator/Dockerfile
    env_file:
      - services/navigator/.env
    ports:
      - '8008:8008'
    depends_on:
      - db
      # - sso-proxy

  cms:
    image: local-workspace/directory-cms
    build:
      context: ../directory-cms/
      dockerfile: services/directory-cms/Dockerfile
    env_file:
      - services/directory-cms/.env
    ports:
      - '8010:8010'
    depends_on:
      - db
      - redis

  forms-api:
    image: local-workspace/directory-forms-api
    build:
      context: ../directory-forms-api/
      dockerfile: services/directory-forms-api/Dockerfile
    env_file:
      - services/directory-forms-api/.env
    ports:
      - '8011:8011'
    depends_on:
      - db
      - redis

  invest:
    image: local-workspace/invest-ui
    build:
      context: ../invest-ui/
      dockerfile: services/invest-ui/Dockerfile
    env_file:
      - services/invest-ui/.env
    ports:
      - '8012:8012'
    depends_on:
      - db
      - redis

  international:
    image: local-workspace/great-international-ui
    build:
      context: ../great-international-ui/
      dockerfile: services/great-international-ui/Dockerfile
    env_file:
      - services/great-international-ui/.env
    ports:
      - '8013:8013'
    depends_on:
      - db
      - redis
      - sso
      - cms
      - forms-api

# volumes:
#   db-data:
#   redis-data:
#   es-data:
